<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Desk Wellness</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #0f0f0d;
    --surface: #1a1a16;
    --surface2: #242420;
    --border: #2e2e28;
    --text: #e8e6df;
    --muted: #7a7870;
    --accent-sit: #c8a96e;
    --accent-stand: #7eb89a;
    --accent-eyes: #8fb5d4;
    --accent-shoulder: #d4a574;
    --accent-wrist: #b8a0cc;
    --accent-walk: #9ab87e;
    --accent-breath: #d4c574;
    --accent-eod: #cc8888;
    --accent-hydration: #74c4d4;
    --accent-focus: #a8b8cc;
    --accent-neck: #d4b8a0;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    min-height: 100vh;
    padding: 60px 24px 24px;
    line-height: 1.5;
  }

  /* ===== TITLE BAR ===== */
  .app-titlebar {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: 36px;
    -webkit-app-region: drag;
    background: color-mix(in srgb, var(--bg) 95%, var(--surface));
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 200;
    user-select: none;
  }

  .app-titlebar-name {
    font-size: 0.6rem;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--muted);
    /* offset right of macOS traffic lights */
    padding-left: 76px;
  }

  .noise {
    position: fixed; inset: 0; pointer-events: none; z-index: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
  }

  .app { position: relative; z-index: 1; max-width: 960px; margin: 0 auto; }

  /* ===== HEADER ===== */
  header {
    display: flex; align-items: baseline; gap: 16px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 16px; margin-bottom: 16px;
  }

  h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 2rem; font-weight: 400;
    color: var(--text); letter-spacing: -0.02em;
  }

  .subtitle { color: var(--muted); font-size: 0.75rem; letter-spacing: 0.08em; text-transform: uppercase; }

  .clock {
    font-size: 0.75rem; color: var(--muted);
    margin-left: auto; letter-spacing: 0.05em;
  }

  /* ===== DAILY STATS BAR ===== */
  .stats-bar {
    display: flex; align-items: center; gap: 24px;
    padding: 10px 16px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 10px;
    margin-bottom: 20px; flex-wrap: wrap;
  }

  .stat-item {
    display: flex; align-items: center; gap: 8px;
  }

  .stat-label {
    font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.1em;
    color: var(--muted);
  }

  .stat-value {
    font-size: 0.8rem; color: var(--text); font-weight: 500;
  }

  .stat-sep { color: var(--border); font-size: 0.8rem; }

  .streak-badge {
    display: inline-flex; align-items: center; gap: 4px;
    font-size: 0.65rem; padding: 2px 8px; border-radius: 20px;
    border: 1px solid var(--accent-stand); color: var(--accent-stand);
  }

  /* Settings + focus buttons in stats bar */
  .stats-actions { margin-left: auto; display: flex; gap: 8px; align-items: center; }

  /* ===== FOCUS MODE BANNER ===== */
  .focus-banner {
    display: none; align-items: center; gap: 12px;
    padding: 10px 16px; background: color-mix(in srgb, var(--accent-focus) 12%, var(--surface));
    border: 1px solid var(--accent-focus); border-radius: 10px;
    margin-bottom: 20px; font-size: 0.72rem;
  }
  .focus-banner.active { display: flex; }
  .focus-banner-label { color: var(--accent-focus); font-weight: 500; }
  .focus-banner-time { color: var(--text); font-size: 1rem; }
  .focus-banner-sub { color: var(--muted); font-size: 0.65rem; }

  /* ===== MAIN GRID ===== */
  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s;
  }

  .card:hover { border-color: #3e3e38; }
  .card.active { animation: pulse-border 2s ease-in-out infinite; }

  .card.focus-paused {
    opacity: 0.45; pointer-events: none;
  }
  .card.focus-paused::after {
    content: 'Focus Mode Active'; position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--accent-focus); pointer-events: none;
  }

  @keyframes pulse-border {
    0%, 100% { border-color: var(--card-accent); box-shadow: 0 0 0 0 color-mix(in srgb, var(--card-accent) 0%, transparent); }
    50% { box-shadow: 0 0 0 3px color-mix(in srgb, var(--card-accent) 20%, transparent); }
  }

  .card-sit { --card-accent: var(--accent-sit); }
  .card-eyes { --card-accent: var(--accent-eyes); }
  .card-shoulder { --card-accent: var(--accent-shoulder); }
  .card-wrist { --card-accent: var(--accent-wrist); }
  .card-walk { --card-accent: var(--accent-walk); }
  .card-breath { --card-accent: var(--accent-breath); }
  .card-eod { --card-accent: var(--accent-eod); grid-column: 1 / -1; }
  .card-hydration { --card-accent: var(--accent-hydration); }
  .card-focus { --card-accent: var(--accent-focus); }
  .card-neck { --card-accent: var(--accent-neck); }

  .card-accent-bar {
    position: absolute; top: 0; left: 0; right: 0;
    height: 2px; background: var(--card-accent);
    transform: scaleX(0); transform-origin: left;
    transition: transform 0.3s;
  }
  .card.active .card-accent-bar { transform: scaleX(1); }

  .card-label {
    font-size: 0.65rem; letter-spacing: 0.12em;
    text-transform: uppercase; color: var(--muted);
    margin-bottom: 8px;
  }

  .card-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.2rem; font-weight: 400;
    color: var(--card-accent);
    margin-bottom: 12px;
  }

  .card-desc {
    font-size: 0.72rem; color: var(--muted);
    margin-bottom: 16px; line-height: 1.6;
  }

  /* ===== TIMER RING ===== */
  .timer-wrap {
    display: flex; align-items: center; gap: 16px;
    margin-bottom: 16px;
  }

  .ring-wrap { position: relative; width: 64px; height: 64px; flex-shrink: 0; }
  .ring-wrap svg { transform: rotate(-90deg); }
  .ring-bg { fill: none; stroke: var(--border); stroke-width: 3; }
  .ring-fill { fill: none; stroke: var(--card-accent); stroke-width: 3; stroke-linecap: round;
    transition: stroke-dashoffset 1s linear; }
  .ring-text {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.65rem; font-weight: 500; color: var(--text);
    letter-spacing: -0.02em;
  }

  .timer-info { flex: 1; }
  .timer-countdown { font-size: 1.4rem; color: var(--text); letter-spacing: -0.03em; }
  .timer-label { font-size: 0.65rem; color: var(--muted); margin-top: 2px; }

  /* ===== BUTTONS ===== */
  .btn-row { display: flex; gap: 8px; flex-wrap: wrap; }

  .btn {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem; letter-spacing: 0.08em;
    text-transform: uppercase; cursor: pointer;
    border: 1px solid var(--border); border-radius: 6px;
    padding: 6px 12px; background: transparent;
    color: var(--muted); transition: all 0.2s;
  }

  .btn:hover { border-color: var(--card-accent); color: var(--card-accent); }
  .btn.primary { background: var(--card-accent); border-color: var(--card-accent); color: var(--bg); font-weight: 500; }
  .btn.primary:hover { opacity: 0.85; }
  .btn:disabled { opacity: 0.3; cursor: not-allowed; }

  /* ===== STAND/SIT TOGGLE ===== */
  .mode-toggle {
    display: flex; gap: 0; border: 1px solid var(--border);
    border-radius: 8px; overflow: hidden; margin-bottom: 16px;
  }

  .mode-btn {
    flex: 1; padding: 8px; background: transparent;
    border: none; cursor: pointer; font-family: 'DM Mono', monospace;
    font-size: 0.65rem; letter-spacing: 0.08em; text-transform: uppercase;
    color: var(--muted); transition: all 0.2s;
  }
  .mode-btn.active-sit { background: var(--accent-sit); color: var(--bg); }
  .mode-btn.active-stand { background: var(--accent-stand); color: var(--bg); }

  /* ===== PROGRESS BAR ===== */
  .pos-progress {
    height: 4px; background: var(--border); border-radius: 2px;
    margin-top: 12px; overflow: hidden;
  }
  .pos-progress-fill {
    height: 100%; border-radius: 2px;
    background: var(--card-accent);
    transition: width 1s linear;
  }

  /* ===== STEPS ===== */
  .steps { list-style: none; }
  .steps li {
    display: flex; align-items: flex-start; gap: 10px;
    padding: 6px 0; border-bottom: 1px solid var(--border);
    font-size: 0.72rem; color: var(--muted); transition: color 0.2s;
  }
  .steps li:last-child { border-bottom: none; }
  .steps li.done { color: var(--accent-stand); }
  .steps li.current { color: var(--text); }

  .step-num {
    font-size: 0.6rem; color: var(--muted);
    min-width: 16px; margin-top: 1px;
  }
  .steps li.done .step-num { color: var(--accent-stand); }
  .steps li.current .step-num { color: var(--card-accent); }

  /* ===== BREATHWORK ANIMATION ===== */
  .breath-visual {
    display: flex; align-items: center; justify-content: center;
    height: 80px; margin-bottom: 16px;
  }

  .breath-circle {
    width: 50px; height: 50px; border-radius: 50%;
    border: 2px solid var(--accent-breath);
    display: flex; align-items: center; justify-content: center;
    font-size: 0.6rem; color: var(--accent-breath);
    text-transform: uppercase; letter-spacing: 0.05em;
    transition: all 0.5s ease;
  }

  .breath-circle.inhale { transform: scale(1.6); background: color-mix(in srgb, var(--accent-breath) 10%, transparent); }
  .breath-circle.hold { transform: scale(1.6); background: color-mix(in srgb, var(--accent-breath) 15%, transparent); }
  .breath-circle.exhale { transform: scale(0.8); background: transparent; }

  /* ===== NOTIFICATION TOAST ===== */
  .toast {
    position: fixed; bottom: 24px; right: 24px; z-index: 1000;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 10px; padding: 14px 18px;
    font-size: 0.75rem; color: var(--text);
    transform: translateY(80px); opacity: 0;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    max-width: 300px;
  }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast-title { font-weight: 500; margin-bottom: 3px; }
  .toast-body { color: var(--muted); font-size: 0.68rem; }

  /* ===== EOD CARD ===== */
  .eod-steps {
    display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
    margin-bottom: 16px;
  }
  .eod-step {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; padding: 10px 12px;
    font-size: 0.68rem; cursor: pointer; transition: all 0.2s;
  }
  .eod-step:hover { border-color: var(--accent-eod); }
  .eod-step.checked { border-color: var(--accent-stand); background: color-mix(in srgb, var(--accent-stand) 8%, var(--surface2)); }
  .eod-step-icon { font-size: 1.1rem; margin-bottom: 4px; }
  .eod-step-label { color: var(--muted); }
  .eod-step.checked .eod-step-label { color: var(--accent-stand); }

  /* ===== SIT/STAND WIDE ===== */
  .card-sitstand { grid-column: 1 / -1; }

  /* ===== HYDRATION CARD ===== */
  .water-tracker {
    display: flex; align-items: center; gap: 12px;
    margin-bottom: 16px;
  }

  .water-glasses {
    display: flex; gap: 5px; flex-wrap: wrap; flex: 1;
  }

  .water-glass {
    width: 22px; height: 28px; border: 1.5px solid var(--border);
    border-radius: 3px 3px 5px 5px; cursor: pointer;
    transition: all 0.2s; position: relative; overflow: hidden;
    background: var(--surface2);
  }

  .water-glass.filled {
    border-color: var(--accent-hydration);
    background: color-mix(in srgb, var(--accent-hydration) 25%, var(--surface2));
  }

  .water-glass::after {
    content: ''; position: absolute; bottom: 0; left: 0; right: 0;
    height: 0; background: var(--accent-hydration);
    transition: height 0.3s ease; opacity: 0.3;
  }

  .water-glass.filled::after { height: 100%; }

  .water-count {
    font-size: 1.4rem; color: var(--text); letter-spacing: -0.03em;
    min-width: 40px; text-align: right;
  }
  .water-goal { font-size: 0.65rem; color: var(--muted); }

  /* ===== FOCUS SESSION CARD ===== */
  .focus-durations {
    display: flex; gap: 6px; margin-bottom: 16px;
  }

  .focus-duration-btn {
    flex: 1; padding: 7px 4px; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 6px;
    font-family: 'DM Mono', monospace; font-size: 0.65rem;
    letter-spacing: 0.05em; color: var(--muted);
    cursor: pointer; transition: all 0.2s; text-align: center;
  }
  .focus-duration-btn:hover { border-color: var(--accent-focus); color: var(--accent-focus); }
  .focus-duration-btn.selected { background: color-mix(in srgb, var(--accent-focus) 20%, var(--surface2)); border-color: var(--accent-focus); color: var(--accent-focus); }

  /* ===== SETTINGS MODAL ===== */
  .modal-overlay {
    display: none; position: fixed; inset: 0; z-index: 500;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
    align-items: center; justify-content: center;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 28px; width: 420px; max-width: 90vw;
    max-height: 80vh; overflow-y: auto;
  }

  .modal-header {
    display: flex; align-items: baseline; justify-content: space-between;
    margin-bottom: 24px;
  }

  .modal-title {
    font-family: 'DM Serif Display', serif;
    font-size: 1.3rem; font-weight: 400;
  }

  .modal-close {
    background: none; border: none; color: var(--muted);
    cursor: pointer; font-size: 1.2rem; padding: 2px 6px;
    border-radius: 4px; transition: color 0.2s;
  }
  .modal-close:hover { color: var(--text); }

  .setting-group { margin-bottom: 20px; }

  .setting-group-title {
    font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.12em;
    color: var(--muted); margin-bottom: 12px;
    padding-bottom: 6px; border-bottom: 1px solid var(--border);
  }

  .setting-row {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 10px;
  }

  .setting-label { font-size: 0.72rem; color: var(--text); }
  .setting-hint { font-size: 0.62rem; color: var(--muted); }

  .setting-input {
    font-family: 'DM Mono', monospace; font-size: 0.72rem;
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); border-radius: 6px; padding: 5px 10px;
    width: 80px; text-align: center;
    transition: border-color 0.2s;
  }
  .setting-input:focus { outline: none; border-color: var(--accent-focus); }

  /* Notification permission banner */
  .notif-banner {
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; padding: 12px 16px;
    display: flex; align-items: center; gap: 12px;
    margin-bottom: 20px; font-size: 0.72rem;
  }
  .notif-banner.hidden { display: none; }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 620px) {
    .grid { grid-template-columns: 1fr; }
    .card-eod { grid-column: 1; }
    .card-sitstand { grid-column: 1; }
    .eod-steps { grid-template-columns: repeat(2, 1fr); }
    h1 { font-size: 1.5rem; }
    .stats-bar { gap: 12px; }
  }

  /* ===== ANALYTICS MODAL ===== */
  .analytics-section { margin-bottom: 24px; }

  .analytics-section-title {
    font-size: 0.6rem; text-transform: uppercase; letter-spacing: 0.12em;
    color: var(--muted); margin-bottom: 14px;
    padding-bottom: 6px; border-bottom: 1px solid var(--border);
  }

  .chart-wrap {
    display: flex; align-items: flex-end; gap: 6px;
    height: 80px; margin-bottom: 6px;
  }

  .chart-col {
    flex: 1; display: flex; flex-direction: column;
    align-items: center; gap: 4px; height: 100%;
  }

  .chart-bar-wrap {
    flex: 1; display: flex; align-items: flex-end;
    width: 100%; min-width: 0;
  }

  .chart-bar {
    width: 100%; border-radius: 3px 3px 0 0;
    min-height: 2px; transition: height 0.4s ease;
  }

  .chart-label {
    font-size: 0.55rem; color: var(--muted);
    text-align: center; white-space: nowrap;
  }

  .chart-val {
    font-size: 0.6rem; font-weight: 500; color: var(--text);
    text-align: center;
  }

  .chart-today .chart-bar { opacity: 1; }
  .chart-col:not(.chart-today) .chart-bar { opacity: 0.6; }
  .chart-today .chart-label { color: var(--text); font-weight: 500; }

  .analytics-summary {
    display: flex; gap: 16px; flex-wrap: wrap; margin-top: 8px;
  }

  .analytics-stat {
    flex: 1; min-width: 80px; background: var(--surface2);
    border: 1px solid var(--border); border-radius: 8px;
    padding: 10px 12px; text-align: center;
  }

  .analytics-stat-val {
    font-size: 1.2rem; color: var(--text);
    letter-spacing: -0.03em; margin-bottom: 2px;
  }

  .analytics-stat-label {
    font-size: 0.58rem; text-transform: uppercase;
    letter-spacing: 0.1em; color: var(--muted);
  }

  /* ===== IDLE BANNER ===== */
  .idle-banner {
    display: none; align-items: center; gap: 12px;
    padding: 10px 16px;
    background: color-mix(in srgb, var(--muted) 8%, var(--surface));
    border: 1px solid var(--border); border-radius: 10px;
    margin-bottom: 20px; font-size: 0.72rem;
  }
  .idle-banner.active { display: flex; }
  .idle-banner-label { color: var(--muted); }

  /* ===== SOUND BADGE ===== */
  .sound-toggle {
    font-size: 0.65rem; padding: 4px 8px; cursor: pointer;
    background: none; border: 1px solid var(--border);
    border-radius: 6px; color: var(--muted);
    font-family: 'DM Mono', monospace; transition: all 0.2s;
  }
  .sound-toggle:hover { border-color: var(--text); color: var(--text); }
  .sound-toggle.muted { opacity: 0.45; }
</style>
</head>
<body>
<div class="app-titlebar">
  <span class="app-titlebar-name">Desk Wellness</span>
</div>
<div class="noise"></div>
<div class="app">

  <header>
    <div>
      <h1>Desk Wellness</h1>
      <div class="subtitle">Workplace recovery companion</div>
    </div>
    <div class="clock" id="clock">--:--</div>
  </header>

  <!-- DAILY STATS BAR -->
  <div class="stats-bar">
    <div class="stat-item">
      <span class="stat-label">Today</span>
      <span class="stat-value" id="statDate">‚Äî</span>
    </div>
    <span class="stat-sep">¬∑</span>
    <div class="stat-item">
      <span class="stat-label">Breaks</span>
      <span class="stat-value" id="statBreaks">0</span>
    </div>
    <span class="stat-sep">¬∑</span>
    <div class="stat-item">
      <span class="stat-label">Water</span>
      <span class="stat-value"><span id="statWater">0</span>/<span id="statWaterGoal">8</span> glasses</span>
    </div>
    <span class="stat-sep">¬∑</span>
    <div class="stat-item">
      <span class="stat-label">Focus sessions</span>
      <span class="stat-value" id="statFocus">0</span>
    </div>
    <span class="stat-sep">¬∑</span>
    <div class="stat-item">
      <span class="stat-label">At desk</span>
      <span class="stat-value" id="statDesk">0h 0m</span>
    </div>
    <div class="stats-actions">
      <div class="streak-badge" id="streakBadge">üî• <span id="streakCount">0</span> <span id="streakLabel">day</span> streak</div>
      <button class="btn sound-toggle" id="soundToggleBtn" onclick="toggleSound()" title="Toggle sound">üîî</button>
      <button class="btn primary" id="masterBtn" onclick="masterToggle()" style="--card-accent: var(--accent-stand);">‚ñ∂ Start All</button>
      <button class="btn" onclick="openAnalytics()" title="Analytics">üìä</button>
      <button class="btn" onclick="openSettings()" title="Settings">‚öô Settings</button>
    </div>
  </div>

  <!-- IDLE BANNER -->
  <div class="idle-banner" id="idleBanner">
    <span>üò¥</span>
    <span class="idle-banner-label">Away detected ‚Äî timers paused</span>
    <button class="btn" onclick="resumeFromIdle()" style="--card-accent: var(--accent-stand); margin-left: auto;">Resume</button>
  </div>

  <!-- FOCUS BANNER -->
  <div class="focus-banner" id="focusBanner">
    <span style="font-size: 1.2rem;">üéØ</span>
    <div>
      <div class="focus-banner-label">Focus Session Active</div>
      <div class="focus-banner-sub">Break reminders paused until session ends</div>
    </div>
    <div class="focus-banner-time" id="focusBannerTime">‚Äî</div>
    <button class="btn" onclick="endFocusSession()" style="margin-left: auto; --card-accent: var(--accent-focus);">End Session</button>
  </div>

  <!-- NOTIFICATION PERMISSION BANNER -->
  <div class="notif-banner" id="notifBanner">
    <span>üîî</span>
    <span style="flex:1; color: var(--muted)">Enable notifications to get reminded even when the window isn't in focus.</span>
    <button class="btn primary" onclick="requestNotifs()" style="--card-accent: var(--accent-focus);">Enable</button>
    <button class="btn" onclick="document.getElementById('notifBanner').classList.add('hidden')">Dismiss</button>
  </div>

  <div class="grid" id="mainGrid">

    <!-- SIT/STAND TIMER -->
    <div class="card card-sitstand card-sit" id="sitstandCard" style="--card-accent: var(--accent-sit)">
      <div class="card-accent-bar"></div>
      <div class="card-label">Position Timer</div>
      <div class="card-title" id="sitstandTitle">Sit / Stand Rhythm</div>

      <div class="mode-toggle">
        <button class="mode-btn active-sit" id="sitBtn" onclick="setMode('sit')">‚¨á Sitting</button>
        <button class="mode-btn" id="standBtn" onclick="setMode('stand')">‚¨Ü Standing</button>
      </div>

      <div class="timer-wrap">
        <div class="ring-wrap">
          <svg width="64" height="64" viewBox="0 0 64 64">
            <circle class="ring-bg" cx="32" cy="32" r="28"/>
            <circle class="ring-fill" id="sitstandRing" cx="32" cy="32" r="28"
              stroke-dasharray="176" stroke-dashoffset="0"/>
          </svg>
          <div class="ring-text" id="sitstandRingText">‚Äî</div>
        </div>
        <div class="timer-info">
          <div class="timer-countdown" id="sitstandCountdown">25:00</div>
          <div class="timer-label" id="sitstandStatus">Ready to start</div>
        </div>
      </div>

      <div class="pos-progress">
        <div class="pos-progress-fill" id="sitstandProgress" style="width:0%"></div>
      </div>

      <div style="margin-top: 14px;">
        <div class="btn-row">
          <button class="btn primary" id="sitstandStartBtn" onclick="toggleSitstand()">Start</button>
          <button class="btn" onclick="resetSitstand()">Reset</button>
        </div>
        <div style="font-size: 0.65rem; color: var(--muted); margin-top: 8px;" id="sitstandHint">
          Sit <span id="hintSit">25</span> min ‚Üí Stand <span id="hintStand">20</span> min ‚Üí repeat
        </div>
      </div>
    </div>

    <!-- 20-20-20 EYES -->
    <div class="card card-eyes" style="--card-accent: var(--accent-eyes)">
      <div class="card-accent-bar"></div>
      <div class="card-label">Eye Strain</div>
      <div class="card-title">20-20-20 Rule</div>
      <div class="card-desc">Every 20 min, look at something 20 ft away for 20 seconds.</div>

      <div class="timer-wrap">
        <div class="ring-wrap">
          <svg width="64" height="64" viewBox="0 0 64 64">
            <circle class="ring-bg" cx="32" cy="32" r="28"/>
            <circle class="ring-fill" id="eyesRing" cx="32" cy="32" r="28"
              stroke-dasharray="176" stroke-dashoffset="0"/>
          </svg>
          <div class="ring-text" id="eyesRingText">‚Äî</div>
        </div>
        <div class="timer-info">
          <div class="timer-countdown" id="eyesCountdown">20:00</div>
          <div class="timer-label" id="eyesStatus">Ready to start</div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn primary" id="eyesStartBtn" onclick="toggleTimer('eyes')">Start</button>
        <button class="btn" onclick="resetTimer('eyes')">Reset</button>
      </div>
    </div>

    <!-- SHOULDER CHECK-IN -->
    <div class="card card-shoulder" style="--card-accent: var(--accent-shoulder)">
      <div class="card-accent-bar"></div>
      <div class="card-label">Posture</div>
      <div class="card-title">Shoulder Check-In</div>
      <div class="card-desc">Reminder to drop and roll your shoulders. Releases desk tension.</div>

      <div class="timer-wrap">
        <div class="ring-wrap">
          <svg width="64" height="64" viewBox="0 0 64 64">
            <circle class="ring-bg" cx="32" cy="32" r="28"/>
            <circle class="ring-fill" id="shoulderRing" cx="32" cy="32" r="28"
              stroke-dasharray="176" stroke-dashoffset="0"/>
          </svg>
          <div class="ring-text" id="shoulderRingText">‚Äî</div>
        </div>
        <div class="timer-info">
          <div class="timer-countdown" id="shoulderCountdown">45:00</div>
          <div class="timer-label" id="shoulderStatus">Ready to start</div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn primary" id="shoulderStartBtn" onclick="toggleTimer('shoulder')">Start</button>
        <button class="btn" onclick="resetTimer('shoulder')">Reset</button>
        <button class="btn" onclick="snoozeTimer('shoulder', 5)">+5 min</button>
      </div>
    </div>

    <!-- WRIST STRETCHES -->
    <div class="card card-wrist" style="--card-accent: var(--accent-wrist)">
      <div class="card-accent-bar"></div>
      <div class="card-label">Recovery</div>
      <div class="card-title">Wrist Stretches</div>
      <div class="card-desc">Quick guided stretch for IT hands. Takes ~90 seconds.</div>

      <div class="timer-wrap">
        <div class="ring-wrap">
          <svg width="64" height="64" viewBox="0 0 64 64">
            <circle class="ring-bg" cx="32" cy="32" r="28"/>
            <circle class="ring-fill" id="wristRing" cx="32" cy="32" r="28"
              stroke-dasharray="176" stroke-dashoffset="0"/>
          </svg>
          <div class="ring-text" id="wristRingText">‚Äî</div>
        </div>
        <div class="timer-info">
          <div class="timer-countdown" id="wristCountdown">60:00</div>
          <div class="timer-label" id="wristTimerStatus">Routine reminder</div>
        </div>
      </div>
      <div class="btn-row" style="margin-bottom: 10px;">
        <button class="btn primary" id="wristTimerBtn" onclick="toggleTimer('wrist')">Start reminder</button>
        <button class="btn" onclick="resetTimer('wrist')">Reset</button>
      </div>

      <ul class="steps" id="wristSteps">
        <li class="current"><span class="step-num">01</span>Extend arm, pull fingers back gently ‚Äî 15 sec</li>
        <li><span class="step-num">02</span>Flip hand down, press back ‚Äî 15 sec</li>
        <li><span class="step-num">03</span>Make fist, then fan fingers wide ‚Äî 5 reps</li>
        <li><span class="step-num">04</span>Wrist circles, both directions ‚Äî 10 each</li>
        <li><span class="step-num">05</span>Prayer hands stretch, hold ‚Äî 20 sec</li>
      </ul>

      <div style="margin-top: 12px;">
        <div class="btn-row">
          <button class="btn primary" id="wristStartBtn" onclick="startWristRoutine()">Start Routine</button>
          <button class="btn" onclick="resetWristRoutine()">Reset</button>
        </div>
      </div>
    </div>

    <!-- NECK STRETCHES -->
    <div class="card card-neck" style="--card-accent: var(--accent-neck)">
      <div class="card-accent-bar"></div>
      <div class="card-label">Neck & Upper Back</div>
      <div class="card-title">Neck Stretches</div>
      <div class="card-desc">Releases forward head posture. Do every 60‚Äì90 min at desk.</div>

      <div class="timer-wrap">
        <div class="ring-wrap">
          <svg width="64" height="64" viewBox="0 0 64 64">
            <circle class="ring-bg" cx="32" cy="32" r="28"/>
            <circle class="ring-fill" id="neckRing" cx="32" cy="32" r="28"
              stroke-dasharray="176" stroke-dashoffset="0"/>
          </svg>
          <div class="ring-text" id="neckRingText">‚Äî</div>
        </div>
        <div class="timer-info">
          <div class="timer-countdown" id="neckCountdown">60:00</div>
          <div class="timer-label" id="neckTimerStatus">Routine reminder</div>
        </div>
      </div>
      <div class="btn-row" style="margin-bottom: 10px;">
        <button class="btn primary" id="neckTimerBtn" onclick="toggleTimer('neck')">Start reminder</button>
        <button class="btn" onclick="resetTimer('neck')">Reset</button>
      </div>

      <ul class="steps" id="neckSteps">
        <li class="current"><span class="step-num">01</span>Ear to shoulder, left side ‚Äî 15 sec</li>
        <li><span class="step-num">02</span>Ear to shoulder, right side ‚Äî 15 sec</li>
        <li><span class="step-num">03</span>Chin tuck: draw chin straight back ‚Äî 10 reps</li>
        <li><span class="step-num">04</span>Slow neck rolls, both directions ‚Äî 30 sec</li>
        <li><span class="step-num">05</span>Shoulder shrug up, hold, release ‚Äî 5 reps</li>
      </ul>

      <div style="margin-top: 12px;">
        <div class="btn-row">
          <button class="btn primary" id="neckStartBtn" onclick="startNeckRoutine()">Start Routine</button>
          <button class="btn" onclick="resetNeckRoutine()">Reset</button>
        </div>
      </div>
    </div>

    <!-- WALK REMINDER -->
    <div class="card card-walk" style="--card-accent: var(--accent-walk)">
      <div class="card-accent-bar"></div>
      <div class="card-label">Movement</div>
      <div class="card-title">Walk Break</div>
      <div class="card-desc">Short walk reduces cortisol and resets focus. Aim for 1x daily minimum.</div>

      <div class="timer-wrap">
        <div class="ring-wrap">
          <svg width="64" height="64" viewBox="0 0 64 64">
            <circle class="ring-bg" cx="32" cy="32" r="28"/>
            <circle class="ring-fill" id="walkRing" cx="32" cy="32" r="28"
              stroke-dasharray="176" stroke-dashoffset="0"/>
          </svg>
          <div class="ring-text" id="walkRingText">‚Äî</div>
        </div>
        <div class="timer-info">
          <div class="timer-countdown" id="walkCountdown">90:00</div>
          <div class="timer-label" id="walkStatus">Ready to start</div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn primary" id="walkStartBtn" onclick="toggleTimer('walk')">Start</button>
        <button class="btn" onclick="resetTimer('walk')">Reset</button>
      </div>
    </div>

    <!-- HYDRATION TRACKER -->
    <div class="card card-hydration" style="--card-accent: var(--accent-hydration)">
      <div class="card-accent-bar"></div>
      <div class="card-label">Hydration</div>
      <div class="card-title">Water Intake</div>
      <div class="card-desc">Aim for 8 glasses today. Dehydration reduces focus by up to 20%.</div>

      <div class="water-tracker">
        <div class="water-glasses" id="waterGlasses"></div>
        <div style="text-align: right;">
          <div class="water-count"><span id="waterCount">0</span></div>
          <div class="water-goal">of 8 glasses</div>
        </div>
      </div>

      <div class="timer-wrap">
        <div class="ring-wrap">
          <svg width="64" height="64" viewBox="0 0 64 64">
            <circle class="ring-bg" cx="32" cy="32" r="28"/>
            <circle class="ring-fill" id="hydrationRing" cx="32" cy="32" r="28"
              stroke-dasharray="176" stroke-dashoffset="0"/>
          </svg>
          <div class="ring-text" id="hydrationRingText">‚Äî</div>
        </div>
        <div class="timer-info">
          <div class="timer-countdown" id="hydrationCountdown">30:00</div>
          <div class="timer-label" id="hydrationStatus">Drink reminder</div>
        </div>
      </div>

      <div class="btn-row">
        <button class="btn primary" onclick="addWaterGlass()" style="--card-accent: var(--accent-hydration);">+ Drank a glass</button>
        <button class="btn" id="hydrationStartBtn" onclick="toggleTimer('hydration')">Start reminder</button>
        <button class="btn" onclick="resetWater()">Reset</button>
      </div>
    </div>

    <!-- FOCUS SESSION -->
    <div class="card card-focus" style="--card-accent: var(--accent-focus)">
      <div class="card-accent-bar"></div>
      <div class="card-label">Deep Work</div>
      <div class="card-title">Focus Session</div>
      <div class="card-desc">Pauses all break reminders so you can work without interruption.</div>

      <div class="focus-durations">
        <div class="focus-duration-btn selected" onclick="selectFocusDuration(25, this)">25 min<br><span style="font-size: 0.55rem; color: var(--muted);">Pomodoro</span></div>
        <div class="focus-duration-btn" onclick="selectFocusDuration(50, this)">50 min<br><span style="font-size: 0.55rem; color: var(--muted);">Deep work</span></div>
        <div class="focus-duration-btn" onclick="selectFocusDuration(90, this)">90 min<br><span style="font-size: 0.55rem; color: var(--muted);">Flow state</span></div>
      </div>

      <div class="timer-wrap">
        <div class="ring-wrap">
          <svg width="64" height="64" viewBox="0 0 64 64">
            <circle class="ring-bg" cx="32" cy="32" r="28"/>
            <circle class="ring-fill" id="focusRing" cx="32" cy="32" r="28"
              stroke-dasharray="176" stroke-dashoffset="0"/>
          </svg>
          <div class="ring-text" id="focusRingText">‚Äî</div>
        </div>
        <div class="timer-info">
          <div class="timer-countdown" id="focusCountdown">25:00</div>
          <div class="timer-label" id="focusStatus">Select duration above</div>
        </div>
      </div>
      <div class="btn-row">
        <button class="btn primary" id="focusStartBtn" onclick="toggleFocusSession()">Start Focus</button>
        <button class="btn" onclick="resetFocusSession()">Reset</button>
      </div>
    </div>

    <!-- PHYSIOLOGICAL SIGH -->
    <div class="card card-breath" style="--card-accent: var(--accent-breath)">
      <div class="card-accent-bar"></div>
      <div class="card-label">Nervous System</div>
      <div class="card-title">Physiological Sigh</div>
      <div class="card-desc">Double inhale through nose, long slow exhale. 1-3 rounds. Fastest stress reset.</div>

      <div class="timer-wrap">
        <div class="ring-wrap">
          <svg width="64" height="64" viewBox="0 0 64 64">
            <circle class="ring-bg" cx="32" cy="32" r="28"/>
            <circle class="ring-fill" id="breathRing" cx="32" cy="32" r="28"
              stroke-dasharray="176" stroke-dashoffset="0"/>
          </svg>
          <div class="ring-text" id="breathRingText">‚Äî</div>
        </div>
        <div class="timer-info">
          <div class="timer-countdown" id="breathCountdown">90:00</div>
          <div class="timer-label" id="breathTimerStatus">Routine reminder</div>
        </div>
      </div>
      <div class="btn-row" style="margin-bottom: 10px;">
        <button class="btn primary" id="breathTimerBtn" onclick="toggleTimer('breath')">Start reminder</button>
        <button class="btn" onclick="resetTimer('breath')">Reset</button>
      </div>

      <div class="breath-visual">
        <div class="breath-circle" id="breathCircle">Ready</div>
      </div>

      <div id="breathInstruction" style="font-size: 0.72rem; color: var(--muted); text-align: center; margin-bottom: 12px; min-height: 18px;"></div>

      <div class="btn-row" style="justify-content: center;">
        <button class="btn primary" id="breathStartBtn" onclick="startBreath()">Begin</button>
        <button class="btn" onclick="stopBreath()">Stop</button>
      </div>
    </div>

    <!-- END OF DAY ROUTINE -->
    <div class="card card-eod" style="--card-accent: var(--accent-eod)">
      <div class="card-accent-bar"></div>
      <div class="card-label">End of Workday</div>
      <div class="card-title">Shutdown Ritual</div>
      <div class="card-desc">Close out the workday intentionally. Check each step when done.</div>

      <div class="eod-steps" id="eodSteps">
        <div class="eod-step" onclick="toggleEod(0)">
          <div class="eod-step-icon">üßò</div>
          <div style="font-size: 0.72rem; margin-bottom: 3px;">Physiological Sigh</div>
          <div class="eod-step-label">Take 2-3 rounds</div>
        </div>
        <div class="eod-step" onclick="toggleEod(1)">
          <div class="eod-step-icon">üôÜ</div>
          <div style="font-size: 0.72rem; margin-bottom: 3px;">Doorway Pec Stretch</div>
          <div class="eod-step-label">30 sec each side</div>
        </div>
        <div class="eod-step" onclick="toggleEod(2)">
          <div class="eod-step-icon">üê±</div>
          <div style="font-size: 0.72rem; margin-bottom: 3px;">Cat-Cow Stretch</div>
          <div class="eod-step-label">60 seconds</div>
        </div>
        <div class="eod-step" onclick="toggleEod(3)">
          <div class="eod-step-icon">üíª</div>
          <div style="font-size: 0.72rem; margin-bottom: 3px;">Close Laptop</div>
          <div class="eod-step-label">Hard stop on work</div>
        </div>
        <div class="eod-step" onclick="toggleEod(4)">
          <div class="eod-step-icon">üö∂</div>
          <div style="font-size: 0.72rem; margin-bottom: 3px;">Short Walk</div>
          <div class="eod-step-label">Even just 10 min</div>
        </div>
        <div class="eod-step" onclick="toggleEod(5)">
          <div class="eod-step-icon">üìù</div>
          <div style="font-size: 0.72rem; margin-bottom: 3px;">Brain Dump</div>
          <div class="eod-step-label">Write tomorrow's top 3</div>
        </div>
      </div>

      <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
        <div id="eodProgress" style="font-size: 0.72rem; color: var(--muted);">0 of 6 complete</div>
        <button class="btn" onclick="resetEod()">Reset</button>
      </div>
    </div>

  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast">
  <div class="toast-title" id="toastTitle"></div>
  <div class="toast-body" id="toastBody"></div>
</div>

<!-- Settings Modal -->
<!-- ANALYTICS MODAL -->
<div class="modal-overlay" id="analyticsModal" onclick="closeAnalyticsOnOverlay(event)">
  <div class="modal" style="max-width: 640px;">
    <div class="modal-header">
      <div class="modal-title">Weekly Analytics</div>
      <button class="modal-close" onclick="closeAnalytics()">‚úï</button>
    </div>

    <div class="analytics-section">
      <div class="analytics-section-title">Breaks completed</div>
      <div class="chart-wrap" id="chartBreaks"></div>
      <div class="chart-days" id="chartBreaksDays" style="display:flex;gap:6px;"></div>
    </div>

    <div class="analytics-section">
      <div class="analytics-section-title">Water glasses</div>
      <div class="chart-wrap" id="chartWater"></div>
      <div class="chart-days" id="chartWaterDays" style="display:flex;gap:6px;"></div>
    </div>

    <div class="analytics-section">
      <div class="analytics-section-title">Focus sessions</div>
      <div class="chart-wrap" id="chartFocus"></div>
      <div class="chart-days" id="chartFocusDays" style="display:flex;gap:6px;"></div>
    </div>

    <div class="analytics-summary" id="analyticsSummary"></div>

    <div class="btn-row" style="justify-content: flex-end; margin-top: 8px;">
      <button class="btn primary" onclick="closeAnalytics()" style="--card-accent: var(--accent-focus);">Close</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="settingsModal" onclick="closeSettingsOnOverlay(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Settings</div>
      <button class="modal-close" onclick="closeSettings()">‚úï</button>
    </div>

    <div class="setting-group">
      <div class="setting-group-title">Sit / Stand Timer</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Sit duration</div>
          <div class="setting-hint">minutes</div>
        </div>
        <input type="number" class="setting-input" id="setSit" value="25" min="5" max="120">
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Stand duration</div>
          <div class="setting-hint">minutes</div>
        </div>
        <input type="number" class="setting-input" id="setStand" value="20" min="5" max="60">
      </div>
    </div>

    <div class="setting-group">
      <div class="setting-group-title">Break Reminders</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Eye break (20-20-20)</div>
          <div class="setting-hint">minutes between reminders</div>
        </div>
        <input type="number" class="setting-input" id="setEyes" value="20" min="5" max="60">
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Shoulder check-in</div>
          <div class="setting-hint">minutes between reminders</div>
        </div>
        <input type="number" class="setting-input" id="setShoulder" value="45" min="10" max="120">
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Walk break</div>
          <div class="setting-hint">minutes between reminders</div>
        </div>
        <input type="number" class="setting-input" id="setWalk" value="90" min="30" max="240">
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Hydration reminder</div>
          <div class="setting-hint">minutes between reminders</div>
        </div>
        <input type="number" class="setting-input" id="setHydration" value="30" min="15" max="90">
      </div>
    </div>

    <div class="setting-group">
      <div class="setting-group-title">Routine Reminders</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Wrist stretches</div>
          <div class="setting-hint">minutes between reminders</div>
        </div>
        <input type="number" class="setting-input" id="setWrist" value="60" min="30" max="120">
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Neck stretches</div>
          <div class="setting-hint">minutes between reminders</div>
        </div>
        <input type="number" class="setting-input" id="setNeck" value="60" min="30" max="120">
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Breathing exercise</div>
          <div class="setting-hint">minutes between reminders</div>
        </div>
        <input type="number" class="setting-input" id="setBreath" value="90" min="30" max="180">
      </div>
    </div>

    <div class="setting-group">
      <div class="setting-group-title">Hydration Goal</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Daily water goal</div>
          <div class="setting-hint">glasses (8 oz each)</div>
        </div>
        <input type="number" class="setting-input" id="setWaterGoal" value="8" min="4" max="16">
      </div>
    </div>

    <div class="setting-group">
      <div class="setting-group-title">Audio</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Completion chimes</div>
          <div class="setting-hint">gentle tone when a timer fires</div>
        </div>
        <button class="btn sound-toggle" id="setSoundToggle" onclick="toggleSoundSetting()" style="min-width: 80px;">üîî On</button>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Volume</div>
          <div class="setting-hint">0 ‚Äì 100</div>
        </div>
        <input type="range" id="setSoundVolume" min="0" max="100" value="60" style="width:100px; accent-color: var(--accent-focus);">
      </div>
    </div>

    <div class="btn-row" style="justify-content: flex-end; margin-top: 8px;">
      <button class="btn" onclick="resetSettings()">Restore Defaults</button>
      <button class="btn primary" onclick="applySettings()" style="--card-accent: var(--accent-focus);">Apply Settings</button>
    </div>
  </div>
</div>

<script>
// ===== STORAGE HELPERS =====
const TODAY = new Date().toISOString().split('T')[0];

// ===== SHARED STATE (declared here to avoid TDZ in any order of calls) =====
let dailyBreaks = 0, dailyFocus = 0;
let waterCount = 0, waterGoal = 8;
let focusActive = false;
let focusDuration = 25 * 60;
let focusRemaining = 25 * 60;
let focusInterval = null;
let soundMuted = false;
let soundVolume = 0.6;
let deskStartTime = Date.now();
let idlePaused = false;
let idleTimeout = null;

function loadState() {
  try {
    const raw = localStorage.getItem('deskWellness');
    return raw ? JSON.parse(raw) : {};
  } catch { return {}; }
}

function saveState(patch) {
  try {
    const state = loadState();
    localStorage.setItem('deskWellness', JSON.stringify({ ...state, ...patch }));
  } catch {}
}

// ===== SETTINGS =====
const DEFAULTS = {
  sitDuration: 25, standDuration: 20,
  eyesDuration: 20, shoulderDuration: 45,
  walkDuration: 90, hydrationDuration: 30,
  wristDuration: 60, neckDuration: 60, breathDuration: 90,
  waterGoal: 8,
  soundMuted: false, soundVolume: 60
};

function getSettings() {
  const s = loadState();
  return { ...DEFAULTS, ...(s.settings || {}) };
}

function openSettings() {
  const cfg = getSettings();
  document.getElementById('setSit').value = cfg.sitDuration;
  document.getElementById('setStand').value = cfg.standDuration;
  document.getElementById('setEyes').value = cfg.eyesDuration;
  document.getElementById('setShoulder').value = cfg.shoulderDuration;
  document.getElementById('setWalk').value = cfg.walkDuration;
  document.getElementById('setHydration').value = cfg.hydrationDuration;
  document.getElementById('setWrist').value = cfg.wristDuration;
  document.getElementById('setNeck').value = cfg.neckDuration;
  document.getElementById('setBreath').value = cfg.breathDuration;
  document.getElementById('setWaterGoal').value = cfg.waterGoal;
  document.getElementById('setSoundVolume').value = cfg.soundMuted ? 0 : cfg.soundVolume;
  const stBtn = document.getElementById('setSoundToggle');
  stBtn.textContent = cfg.soundMuted ? 'üîï Off' : 'üîî On';
  stBtn.classList.toggle('muted', cfg.soundMuted);
  document.getElementById('settingsModal').classList.add('open');
}

function closeSettings() {
  document.getElementById('settingsModal').classList.remove('open');
}

function closeSettingsOnOverlay(e) {
  if (e.target === document.getElementById('settingsModal')) closeSettings();
}

function resetSettings() {
  const cfg = DEFAULTS;
  document.getElementById('setSit').value = cfg.sitDuration;
  document.getElementById('setStand').value = cfg.standDuration;
  document.getElementById('setEyes').value = cfg.eyesDuration;
  document.getElementById('setShoulder').value = cfg.shoulderDuration;
  document.getElementById('setWalk').value = cfg.walkDuration;
  document.getElementById('setHydration').value = cfg.hydrationDuration;
  document.getElementById('setWrist').value = cfg.wristDuration;
  document.getElementById('setNeck').value = cfg.neckDuration;
  document.getElementById('setBreath').value = cfg.breathDuration;
  document.getElementById('setWaterGoal').value = cfg.waterGoal;
}

function applySettings() {
  const newMuted = document.getElementById('setSoundToggle').classList.contains('muted');
  const newVolume = parseInt(document.getElementById('setSoundVolume').value) || 60;
  const cfg = {
    sitDuration:       Math.max(5,  Math.min(120, parseInt(document.getElementById('setSit').value) || 25)),
    standDuration:     Math.max(5,  Math.min(60,  parseInt(document.getElementById('setStand').value) || 20)),
    eyesDuration:      Math.max(5,  Math.min(60,  parseInt(document.getElementById('setEyes').value) || 20)),
    shoulderDuration:  Math.max(10, Math.min(120, parseInt(document.getElementById('setShoulder').value) || 45)),
    walkDuration:      Math.max(30, Math.min(240, parseInt(document.getElementById('setWalk').value) || 90)),
    hydrationDuration: Math.max(15, Math.min(90,  parseInt(document.getElementById('setHydration').value) || 30)),
    wristDuration:     Math.max(30, Math.min(120, parseInt(document.getElementById('setWrist').value) || 60)),
    neckDuration:      Math.max(30, Math.min(120, parseInt(document.getElementById('setNeck').value) || 60)),
    breathDuration:    Math.max(30, Math.min(180, parseInt(document.getElementById('setBreath').value) || 90)),
    waterGoal:         Math.max(4,  Math.min(16,  parseInt(document.getElementById('setWaterGoal').value) || 8)),
    soundMuted: newMuted,
    soundVolume: newVolume,
  };
  saveState({ settings: cfg });
  soundMuted = newMuted;
  soundVolume = newVolume / 100;
  syncSoundBtn();

  // Apply to active timers
  timers.eyes.duration = cfg.eyesDuration * 60;
  timers.shoulder.duration = cfg.shoulderDuration * 60;
  timers.walk.duration = cfg.walkDuration * 60;
  timers.hydration.duration = cfg.hydrationDuration * 60;
  timers.wrist.duration = cfg.wristDuration * 60;
  timers.neck.duration = cfg.neckDuration * 60;
  timers.breath.duration = cfg.breathDuration * 60;
  SS.durations.sit = cfg.sitDuration * 60;
  SS.durations.stand = cfg.standDuration * 60;

  // Update hint text
  document.getElementById('hintSit').textContent = cfg.sitDuration;
  document.getElementById('hintStand').textContent = cfg.standDuration;

  // Update water goal
  waterGoal = cfg.waterGoal;
  renderWaterGlasses();

  // Reset timers that aren't running to reflect new durations
  ['eyes', 'shoulder', 'walk', 'hydration', 'wrist', 'neck', 'breath'].forEach(k => {
    const t = timers[k];
    if (!t.running) {
      t.remaining = t.duration;
      document.getElementById(t.countdownId).textContent = fmt(t.duration);
      updateRing(t, t.duration, t.duration);
    }
  });
  if (!SS.running) {
    SS.remaining = SS.durations[SS.mode];
    document.getElementById('sitstandCountdown').textContent = fmt(SS.remaining);
    updateSSRing();
  }

  closeSettings();
  showToast('Settings applied', 'Timer durations updated.');
}

// ===== CLOCK =====
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent =
    now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}
setInterval(updateClock, 1000);
updateClock();

// ===== DAILY STATS =====

function loadDailyStats() {
  const s = loadState();
  if (s.statsDate && s.statsDate !== TODAY) {
    // New day ‚Äî archive yesterday's totals before resetting
    const history = s.history || {};
    history[s.statsDate] = {
      breaks: s.dailyBreaks || 0,
      water:  s.dailyWater  || 0,
      focus:  s.dailyFocus  || 0,
    };
    // Keep only last 30 days
    const keys = Object.keys(history).sort();
    while (keys.length > 30) { delete history[keys.shift()]; }
    saveState({ history, statsDate: TODAY, dailyBreaks: 0, dailyFocus: 0, dailyWater: 0 });
    dailyBreaks = 0; dailyFocus = 0;
    waterCount = 0;
  } else {
    dailyBreaks = s.dailyBreaks || 0;
    dailyFocus  = s.dailyFocus  || 0;
    waterCount  = s.dailyWater  || 0;
    if (!s.statsDate) saveState({ statsDate: TODAY });
  }
  // Load sound prefs
  const cfg = getSettings();
  soundMuted = cfg.soundMuted;
  soundVolume = cfg.soundVolume / 100;
  syncSoundBtn();
  updateStatsBar();
}

function updateStatsBar() {
  const d = new Date();
  document.getElementById('statDate').textContent =
    d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  document.getElementById('statBreaks').textContent = dailyBreaks;
  document.getElementById('statWater').textContent = waterCount;
  document.getElementById('statFocus').textContent = dailyFocus;
}

function incrementBreaks() {
  dailyBreaks++;
  saveState({ dailyBreaks });
  updateStatsBar();
}

function incrementFocus() {
  dailyFocus++;
  saveState({ dailyFocus });
  updateStatsBar();
}

// ===== STREAK TRACKING =====
function loadStreak() {
  const s = loadState();
  const streak = s.streak || 0;
  const lastActiveDate = s.lastActiveDate || null;
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  const yesterdayStr = yesterday.toISOString().split('T')[0];

  let currentStreak = streak;
  if (lastActiveDate === TODAY) {
    // Already updated today
    currentStreak = streak;
  } else if (lastActiveDate === yesterdayStr) {
    // Continuing streak
    currentStreak = streak + 1;
    saveState({ streak: currentStreak, lastActiveDate: TODAY });
  } else if (lastActiveDate === null) {
    // First time
    currentStreak = 1;
    saveState({ streak: 1, lastActiveDate: TODAY });
  } else {
    // Streak broken
    currentStreak = 1;
    saveState({ streak: 1, lastActiveDate: TODAY });
  }

  document.getElementById('streakCount').textContent = currentStreak;
  document.getElementById('streakLabel').textContent = currentStreak === 1 ? 'day' : 'days';
}

// ===== NOTIFICATIONS =====
function requestNotifs() {
  if ('Notification' in window) {
    Notification.requestPermission().then(p => {
      if (p === 'granted') {
        document.getElementById('notifBanner').classList.add('hidden');
        showToast('Notifications enabled', "You'll be alerted even when the window is minimized.");
      }
    });
  }
}

if ('Notification' in window && Notification.permission === 'granted') {
  document.getElementById('notifBanner').classList.add('hidden');
}

function notify(title, body) {
  if (!focusActive) {
    if ('Notification' in window && Notification.permission === 'granted') {
      new Notification(title, { body });
    }
    showToast(title, body);
  }
}

// ===== TOAST =====
let toastTimeout;
function showToast(title, body) {
  const t = document.getElementById('toast');
  document.getElementById('toastTitle').textContent = title;
  document.getElementById('toastBody').textContent = body;
  t.classList.add('show');
  clearTimeout(toastTimeout);
  toastTimeout = setTimeout(() => t.classList.remove('show'), 4500);
}

// ===== GENERIC TIMER ENGINE =====
const timers = {
  eyes:       { duration: 20*60, remaining: 20*60, interval: null, running: false,
                ringId: 'eyesRing', ringTextId: 'eyesRingText',
                countdownId: 'eyesCountdown', statusId: 'eyesStatus', btnId: 'eyesStartBtn',
                alertTitle: 'üëÅ Eye Break!', alertBody: 'Look 20 ft away for 20 seconds.' },
  shoulder:   { duration: 45*60, remaining: 45*60, interval: null, running: false,
                ringId: 'shoulderRing', ringTextId: 'shoulderRingText',
                countdownId: 'shoulderCountdown', statusId: 'shoulderStatus', btnId: 'shoulderStartBtn',
                alertTitle: 'üíÜ Shoulder Check!', alertBody: 'Drop your shoulders. Roll them back.' },
  walk:       { duration: 90*60, remaining: 90*60, interval: null, running: false,
                ringId: 'walkRing', ringTextId: 'walkRingText',
                countdownId: 'walkCountdown', statusId: 'walkStatus', btnId: 'walkStartBtn',
                alertTitle: 'üö∂ Walk Time!', alertBody: 'Step outside. Even 10 minutes helps.' },
  hydration:  { duration: 30*60, remaining: 30*60, interval: null, running: false,
                ringId: 'hydrationRing', ringTextId: 'hydrationRingText',
                countdownId: 'hydrationCountdown', statusId: 'hydrationStatus', btnId: 'hydrationStartBtn',
                alertTitle: 'üíß Drink Water!', alertBody: "Stay hydrated ‚Äî your brain is 75% water.",
                isReminder: true, defaultStatus: 'Drink reminder' },
  wrist:      { duration: 60*60, remaining: 60*60, interval: null, running: false,
                ringId: 'wristRing', ringTextId: 'wristRingText',
                countdownId: 'wristCountdown', statusId: 'wristTimerStatus', btnId: 'wristTimerBtn',
                alertTitle: 'ü§≤ Wrist Stretch Time!', alertBody: 'Quick 90-second routine for your wrists and hands.',
                isReminder: true, defaultStatus: 'Routine reminder',
                completedStatus: 'Do the routine below ‚Üì' },
  neck:       { duration: 60*60, remaining: 60*60, interval: null, running: false,
                ringId: 'neckRing', ringTextId: 'neckRingText',
                countdownId: 'neckCountdown', statusId: 'neckTimerStatus', btnId: 'neckTimerBtn',
                alertTitle: 'üßò Neck Stretch Time!', alertBody: 'Relieve forward head posture. Takes ~90 seconds.',
                isReminder: true, defaultStatus: 'Routine reminder',
                completedStatus: 'Do the routine below ‚Üì' },
  breath:     { duration: 90*60, remaining: 90*60, interval: null, running: false,
                ringId: 'breathRing', ringTextId: 'breathRingText',
                countdownId: 'breathCountdown', statusId: 'breathTimerStatus', btnId: 'breathTimerBtn',
                alertTitle: 'ü´Å Breathing Break', alertBody: 'Take 3 physiological sighs to reset stress now.',
                isReminder: true, defaultStatus: 'Routine reminder',
                completedStatus: 'Do the exercise below ‚Üì' },
};

function fmt(s) {
  const m = Math.floor(s/60), sec = s%60;
  return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}

function updateRing(t, remaining, duration) {
  const circ = 176;
  const pct = remaining / duration;
  const offset = circ * (1 - pct);
  document.getElementById(t.ringId).style.strokeDashoffset = offset;
  const mins = Math.ceil(remaining/60);
  document.getElementById(t.ringTextId).textContent = mins < 60 ? mins+'m' : '‚Äî';
}

// ===== MASTER START / PAUSE =====
const MASTER_KEYS = ['eyes', 'shoulder', 'walk', 'hydration', 'wrist', 'neck', 'breath'];

function allRunning() {
  return SS.running && MASTER_KEYS.every(k => timers[k].running);
}

function syncMasterBtn() {
  const btn = document.getElementById('masterBtn');
  if (allRunning()) {
    btn.textContent = '‚è∏ Pause All';
    btn.style.setProperty('--card-accent', 'var(--accent-shoulder)');
  } else {
    btn.textContent = '‚ñ∂ Start All';
    btn.style.setProperty('--card-accent', 'var(--accent-stand)');
  }
}

function masterToggle() {
  if (allRunning()) {
    // Pause everything
    if (SS.running) toggleSitstand();
    MASTER_KEYS.forEach(k => { if (timers[k].running) toggleTimer(k); });
  } else {
    // Start anything not already running
    if (!SS.running) toggleSitstand();
    MASTER_KEYS.forEach(k => { if (!timers[k].running) toggleTimer(k); });
  }
  // syncMasterBtn is called inside toggleSitstand/toggleTimer, but call once more to be safe
  syncMasterBtn();
}

function toggleTimer(key) {
  const t = timers[key];
  if (t.running) {
    clearInterval(t.interval); t.running = false;
    clearPreBreakWarning(key);
    document.getElementById(t.btnId).textContent = t.isReminder ? 'Resume reminder' : 'Resume';
    document.getElementById(t.statusId).textContent = 'Paused';
  } else {
    t.running = true;
    document.getElementById(t.btnId).textContent = 'Pause';
    document.getElementById(t.statusId).textContent = 'Running';
    schedulePreBreakWarning(key);
    t.interval = setInterval(() => {
      t.remaining--;
      document.getElementById(t.countdownId).textContent = fmt(t.remaining);
      updateRing(t, t.remaining, t.duration);
      if (t.remaining <= 0) {
        clearInterval(t.interval); t.running = false;
        clearPreBreakWarning(key);
        playChime('break');
        notify(t.alertTitle, t.alertBody);
        if (t.onComplete) t.onComplete();
        incrementBreaks();
        document.getElementById(t.countdownId).textContent = fmt(t.duration);
        document.getElementById(t.statusId).textContent = t.completedStatus || '‚úì Done ‚Äî restarting';
        document.getElementById(t.btnId).textContent = t.isReminder ? 'Start reminder' : 'Start';
        t.remaining = t.duration;
        updateRing(t, t.remaining, t.duration);
        syncMasterBtn();
      }
    }, 1000);
  }
  syncMasterBtn();
}

function resetTimer(key) {
  const t = timers[key];
  clearInterval(t.interval); t.running = false;
  clearPreBreakWarning(key);
  t.remaining = t.duration;
  document.getElementById(t.countdownId).textContent = fmt(t.duration);
  document.getElementById(t.statusId).textContent = t.defaultStatus || 'Ready to start';
  document.getElementById(t.btnId).textContent = t.isReminder ? 'Start reminder' : 'Start';
  updateRing(t, t.duration, t.duration);
  syncMasterBtn();
}

function snoozeTimer(key, mins) {
  timers[key].remaining += mins * 60;
  document.getElementById(timers[key].countdownId).textContent = fmt(timers[key].remaining);
}

// ===== SIT/STAND TIMER =====
const SS = {
  mode: 'sit',
  durations: { sit: 25*60, stand: 20*60 },
  remaining: 25*60,
  running: false,
  interval: null
};

function setMode(mode) {
  SS.mode = mode;
  SS.remaining = SS.durations[mode];
  const card = document.getElementById('sitstandCard');
  const accent = mode === 'sit' ? 'var(--accent-sit)' : 'var(--accent-stand)';
  card.style.setProperty('--card-accent', accent);
  document.getElementById('sitBtn').className = 'mode-btn' + (mode === 'sit' ? ' active-sit' : '');
  document.getElementById('standBtn').className = 'mode-btn' + (mode === 'stand' ? ' active-stand' : '');
  document.getElementById('sitstandCountdown').textContent = fmt(SS.remaining);
  document.getElementById('sitstandStatus').textContent = `Ready ‚Äî ${mode === 'sit' ? 'sitting' : 'standing'}`;
  updateSSRing();
}

function updateSSRing() {
  const circ = 176;
  const dur = SS.durations[SS.mode];
  const pct = SS.remaining / dur;
  const offset = circ * (1 - pct);
  document.getElementById('sitstandRing').style.strokeDashoffset = offset;
  document.getElementById('sitstandProgress').style.width = ((1-pct)*100) + '%';
  const mins = Math.ceil(SS.remaining/60);
  document.getElementById('sitstandRingText').textContent = mins+'m';
}

function toggleSitstand() {
  if (SS.running) {
    clearInterval(SS.interval); SS.running = false;
    document.getElementById('sitstandStartBtn').textContent = 'Resume';
    document.getElementById('sitstandStatus').textContent = 'Paused';
  } else {
    SS.running = true;
    document.getElementById('sitstandStartBtn').textContent = 'Pause';
    document.getElementById('sitstandStatus').textContent = SS.mode === 'sit' ? 'Sitting...' : 'Standing...';
    SS.interval = setInterval(() => {
      SS.remaining--;
      document.getElementById('sitstandCountdown').textContent = fmt(SS.remaining);
      updateSSRing();
      if (SS.remaining <= 0) {
        clearInterval(SS.interval); SS.running = false;
        const next = SS.mode === 'sit' ? 'stand' : 'sit';
        const msg = next === 'stand' ? 'Time to stand up!' : 'Time to sit down.';
        playChime('sitstand');
        notify('‚è± Position Change', msg);
        incrementBreaks();
        document.getElementById('sitstandStartBtn').textContent = 'Start';
        setMode(next);
        syncMasterBtn();
      }
    }, 1000);
  }
  syncMasterBtn();
}

function resetSitstand() {
  clearInterval(SS.interval); SS.running = false;
  setMode('sit');
  document.getElementById('sitstandStartBtn').textContent = 'Start';
  syncMasterBtn();
}

// ===== WRIST ROUTINE =====
const wristDurations = [15, 15, 12, 12, 20];
let wristStep = 0, wristInterval = null, wristRunning = false, wristRemaining = 0;

function startWristRoutine() {
  if (wristRunning) return;
  wristRunning = true; wristStep = 0;
  document.getElementById('wristStartBtn').textContent = 'Running...';
  document.getElementById('wristStartBtn').disabled = true;
  runWristStep();
}

function runWristStep() {
  if (wristStep >= wristDurations.length) {
    wristRunning = false;
    document.getElementById('wristStartBtn').textContent = 'Done ‚úì';
    document.getElementById('wristStartBtn').disabled = false;
    showToast('Wrist routine complete ‚úì', 'Nice work ‚Äî reminder timer restarted.');
    incrementBreaks();
    if (!timers.wrist.running) toggleTimer('wrist');
    return;
  }
  updateWristHighlight();
  wristRemaining = wristDurations[wristStep];
  wristInterval = setInterval(() => {
    wristRemaining--;
    if (wristRemaining <= 0) {
      clearInterval(wristInterval);
      wristStep++;
      runWristStep();
    }
  }, 1000);
}

function updateWristHighlight() {
  document.querySelectorAll('#wristSteps li').forEach((li, i) => {
    li.className = i < wristStep ? 'done' : i === wristStep ? 'current' : '';
  });
}

function resetWristRoutine() {
  clearInterval(wristInterval);
  wristRunning = false; wristStep = 0; wristRemaining = 0;
  document.getElementById('wristStartBtn').textContent = 'Start Routine';
  document.getElementById('wristStartBtn').disabled = false;
  document.querySelectorAll('#wristSteps li').forEach((li, i) => {
    li.className = i === 0 ? 'current' : '';
  });
}

// ===== NECK ROUTINE =====
const neckDurations = [15, 15, 20, 30, 15];
let neckStep = 0, neckInterval = null, neckRunning = false, neckRemaining = 0;

function startNeckRoutine() {
  if (neckRunning) return;
  neckRunning = true; neckStep = 0;
  document.getElementById('neckStartBtn').textContent = 'Running...';
  document.getElementById('neckStartBtn').disabled = true;
  runNeckStep();
}

function runNeckStep() {
  if (neckStep >= neckDurations.length) {
    neckRunning = false;
    document.getElementById('neckStartBtn').textContent = 'Done ‚úì';
    document.getElementById('neckStartBtn').disabled = false;
    showToast('Neck routine complete ‚úì', 'Forward head posture relieved ‚Äî reminder timer restarted.');
    incrementBreaks();
    if (!timers.neck.running) toggleTimer('neck');
    return;
  }
  updateNeckHighlight();
  neckRemaining = neckDurations[neckStep];
  neckInterval = setInterval(() => {
    neckRemaining--;
    if (neckRemaining <= 0) {
      clearInterval(neckInterval);
      neckStep++;
      runNeckStep();
    }
  }, 1000);
}

function updateNeckHighlight() {
  document.querySelectorAll('#neckSteps li').forEach((li, i) => {
    li.className = i < neckStep ? 'done' : i === neckStep ? 'current' : '';
  });
}

function resetNeckRoutine() {
  clearInterval(neckInterval);
  neckRunning = false; neckStep = 0; neckRemaining = 0;
  document.getElementById('neckStartBtn').textContent = 'Start Routine';
  document.getElementById('neckStartBtn').disabled = false;
  document.querySelectorAll('#neckSteps li').forEach((li, i) => {
    li.className = i === 0 ? 'current' : '';
  });
}

// ===== HYDRATION TRACKER =====

function renderWaterGlasses() {
  const container = document.getElementById('waterGlasses');
  const cfg = getSettings();
  waterGoal = cfg.waterGoal;
  container.innerHTML = '';
  for (let i = 0; i < waterGoal; i++) {
    const g = document.createElement('div');
    g.className = 'water-glass' + (i < waterCount ? ' filled' : '');
    g.title = `Glass ${i + 1}`;
    g.onclick = () => setWaterCount(i < waterCount ? i : i + 1);
    container.appendChild(g);
  }
  document.getElementById('waterCount').textContent = waterCount;
  document.getElementById('statWater').textContent = waterCount;
  document.getElementById('statWaterGoal').textContent = waterGoal;
}

function setWaterCount(n) {
  waterCount = Math.max(0, Math.min(waterGoal, n));
  saveState({ dailyWater: waterCount });
  renderWaterGlasses();
  if (waterCount === waterGoal) {
    showToast('Hydration goal reached! üíß', `${waterGoal} glasses today ‚Äî excellent.`);
  }
}

function addWaterGlass() {
  if (waterCount < waterGoal) {
    setWaterCount(waterCount + 1);
    showToast('Water logged', `${waterCount} of ${waterGoal} glasses today.`);
  } else {
    showToast('Goal already reached!', `${waterGoal} glasses today. Great work.`);
  }
}

function resetWater() {
  setWaterCount(0);
}

// ===== FOCUS SESSION =====

function selectFocusDuration(mins, el) {
  focusDuration = mins * 60;
  focusRemaining = focusDuration;
  document.getElementById('focusCountdown').textContent = fmt(focusRemaining);
  document.getElementById('focusStatus').textContent = 'Select duration above';
  updateFocusRing();
  document.querySelectorAll('.focus-duration-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
}

function updateFocusRing() {
  const circ = 176;
  const pct = focusRemaining / focusDuration;
  const offset = circ * (1 - pct);
  document.getElementById('focusRing').style.strokeDashoffset = offset;
  const mins = Math.ceil(focusRemaining / 60);
  document.getElementById('focusRingText').textContent = mins + 'm';
}

function toggleFocusSession() {
  if (focusActive) {
    clearInterval(focusInterval); focusActive = false;
    document.getElementById('focusStartBtn').textContent = 'Resume Focus';
    document.getElementById('focusStatus').textContent = 'Paused';
    document.getElementById('focusBanner').classList.remove('active');
    applyFocusMode(false);
  } else {
    focusActive = true;
    document.getElementById('focusStartBtn').textContent = 'Pause';
    document.getElementById('focusStatus').textContent = 'Focus active ‚Äî reminders paused';
    document.getElementById('focusBanner').classList.add('active');
    applyFocusMode(true);
    focusInterval = setInterval(() => {
      focusRemaining--;
      document.getElementById('focusCountdown').textContent = fmt(focusRemaining);
      document.getElementById('focusBannerTime').textContent = fmt(focusRemaining);
      updateFocusRing();
      if (focusRemaining <= 0) {
        endFocusSession();
        notify('üéØ Focus Session Complete!', 'Great work. Take a break ‚Äî your reminders are back on.');
        incrementFocus();
      }
    }, 1000);
  }
}

function endFocusSession() {
  clearInterval(focusInterval); focusActive = false;
  focusRemaining = focusDuration;
  document.getElementById('focusStartBtn').textContent = 'Start Focus';
  document.getElementById('focusStatus').textContent = 'Session ended';
  document.getElementById('focusCountdown').textContent = fmt(focusDuration);
  document.getElementById('focusBanner').classList.remove('active');
  document.getElementById('focusBannerTime').textContent = '‚Äî';
  applyFocusMode(false);
  updateFocusRing();
}

function resetFocusSession() {
  endFocusSession();
  document.getElementById('focusStatus').textContent = 'Select duration above';
  document.getElementById('focusStartBtn').textContent = 'Start Focus';
}

function applyFocusMode(active) {
  const pausableCards = document.querySelectorAll('.card-eyes, .card-shoulder, .card-walk, .card-hydration');
  pausableCards.forEach(card => {
    card.classList.toggle('focus-paused', active);
  });
}

// ===== PHYSIOLOGICAL SIGH =====
const breathPhases = [
  { label: 'Inhale', cls: 'inhale', dur: 2000, instruction: 'First inhale ‚Äî nose, fill lungs' },
  { label: 'Inhale+', cls: 'inhale', dur: 1000, instruction: 'Second short inhale ‚Äî top up lungs' },
  { label: 'Exhale', cls: 'exhale', dur: 6000, instruction: 'Long slow exhale through mouth...' },
  { label: 'Pause', cls: '', dur: 1500, instruction: 'Natural pause ‚Äî ready for next round?' },
];

let breathPhaseIdx = 0, breathRound = 0, breathTimeout = null, breathActive = false;

function startBreath() {
  if (breathActive) return;
  breathActive = true; breathRound = 0; breathPhaseIdx = 0;
  document.getElementById('breathStartBtn').textContent = 'Running...';
  runBreathPhase();
}

function runBreathPhase() {
  if (breathRound >= 3) {
    stopBreath();
    showToast('Sigh complete ‚úì', 'Nervous system reset. Reminder timer restarted.');
    incrementBreaks();
    if (!timers.breath.running) toggleTimer('breath');
    return;
  }
  const phase = breathPhases[breathPhaseIdx];
  const circle = document.getElementById('breathCircle');
  circle.className = 'breath-circle ' + phase.cls;
  circle.textContent = phase.label;
  document.getElementById('breathInstruction').textContent = phase.instruction;

  breathTimeout = setTimeout(() => {
    breathPhaseIdx++;
    if (breathPhaseIdx >= breathPhases.length) {
      breathPhaseIdx = 0; breathRound++;
    }
    runBreathPhase();
  }, phase.dur);
}

function stopBreath() {
  clearTimeout(breathTimeout); breathActive = false;
  breathPhaseIdx = 0; breathRound = 0;
  const circle = document.getElementById('breathCircle');
  circle.className = 'breath-circle';
  circle.textContent = 'Ready';
  document.getElementById('breathInstruction').textContent = '';
  document.getElementById('breathStartBtn').textContent = 'Begin';
}

// ===== EOD CHECKLIST =====
let eodChecked = [false,false,false,false,false,false];

function loadEodState() {
  const s = loadState();
  if (s.eodDate === TODAY && Array.isArray(s.eodChecked)) {
    eodChecked = s.eodChecked;
    document.querySelectorAll('.eod-step').forEach((el, i) => {
      el.classList.toggle('checked', eodChecked[i]);
    });
    const done = eodChecked.filter(Boolean).length;
    document.getElementById('eodProgress').textContent = `${done} of 6 complete`;
  }
}

function toggleEod(idx) {
  eodChecked[idx] = !eodChecked[idx];
  const steps = document.querySelectorAll('.eod-step');
  steps[idx].classList.toggle('checked', eodChecked[idx]);
  const done = eodChecked.filter(Boolean).length;
  document.getElementById('eodProgress').textContent = `${done} of 6 complete`;
  saveState({ eodChecked, eodDate: TODAY });
  if (done === 6) {
    showToast('Workday closed ‚úì', 'Great shutdown. Enjoy your evening!');
  }
}

function resetEod() {
  eodChecked.fill(false);
  document.querySelectorAll('.eod-step').forEach(s => s.classList.remove('checked'));
  document.getElementById('eodProgress').textContent = '0 of 6 complete';
  saveState({ eodChecked: eodChecked, eodDate: TODAY });
}

// ===== AUDIO CHIMES =====
let _audioCtx = null;
function getAudioCtx() {
  if (!_audioCtx) _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return _audioCtx;
}

function playChime(type) {
  if (soundMuted) return;
  try {
    const ctx = getAudioCtx();
    const gain = ctx.createGain();
    gain.gain.setValueAtTime(soundVolume * 0.3, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 1.2);
    gain.connect(ctx.destination);

    const freqs = type === 'sitstand'
      ? [523, 659, 784]   // C5-E5-G5 ‚Äî bright chord
      : [392, 523, 659];  // G4-C5-E5 ‚Äî gentle chord

    freqs.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, ctx.currentTime + i * 0.08);
      osc.connect(gain);
      osc.start(ctx.currentTime + i * 0.08);
      osc.stop(ctx.currentTime + 1.2);
    });
  } catch (_) {}
}

function toggleSound() {
  soundMuted = !soundMuted;
  const cfg = getSettings();
  cfg.soundMuted = soundMuted;
  saveState({ settings: cfg });
  syncSoundBtn();
  if (!soundMuted) playChime('break'); // preview
}

function toggleSoundSetting() {
  const btn = document.getElementById('setSoundToggle');
  const isMuted = btn.classList.toggle('muted');
  btn.textContent = isMuted ? 'üîï Off' : 'üîî On';
}

function syncSoundBtn() {
  const btn = document.getElementById('soundToggleBtn');
  if (!btn) return;
  btn.textContent = soundMuted ? 'üîï' : 'üîî';
  btn.classList.toggle('muted', soundMuted);
  btn.title = soundMuted ? 'Sound off (click to enable)' : 'Sound on (click to mute)';
}

// ===== PRE-BREAK WARNING =====
const preBreakTimers = {};  // key ‚Üí timeoutId

function schedulePreBreakWarning(key) {
  clearPreBreakWarning(key);
  const t = timers[key];
  const warnAt = t.remaining - 60;  // 60s before
  if (warnAt > 0) {
    preBreakTimers[key] = setTimeout(() => {
      if (timers[key].running) {
        showToast('‚è∞ Upcoming break', `${t.alertTitle.replace(/[^a-zA-Z ]/g, '').trim()} in 1 minute`);
      }
    }, warnAt * 1000);
  }
}

function clearPreBreakWarning(key) {
  if (preBreakTimers[key]) {
    clearTimeout(preBreakTimers[key]);
    delete preBreakTimers[key];
  }
}

// ===== SESSION TIME TRACKER =====
function updateDeskTime() {
  const elapsed = Math.floor((Date.now() - deskStartTime) / 1000);
  const h = Math.floor(elapsed / 3600);
  const m = Math.floor((elapsed % 3600) / 60);
  document.getElementById('statDesk').textContent = `${h}h ${m}m`;
}
setInterval(updateDeskTime, 60000);
updateDeskTime();

// ===== IDLE / AWAY DETECTION =====
const IDLE_THRESHOLD = 5 * 60 * 1000; // 5 minutes
let lastActivity = Date.now();
let idleCheckInterval = null;

function resetActivity() {
  lastActivity = Date.now();
  if (idlePaused) resumeFromIdle();
}

function resumeFromIdle() {
  if (!idlePaused) return;
  idlePaused = false;
  document.getElementById('idleBanner').classList.remove('active');
  // Re-start all timers that were running before idle
  const wasRunning = JSON.parse(sessionStorage.getItem('idlePausedTimers') || '[]');
  wasRunning.forEach(key => {
    if (key === '__SS__') { if (!SS.running) toggleSitstand(); }
    else if (timers[key] && !timers[key].running) toggleTimer(key);
  });
  sessionStorage.removeItem('idlePausedTimers');
}

['mousemove','keydown','mousedown','touchstart','scroll'].forEach(ev => {
  document.addEventListener(ev, resetActivity, { passive: true });
});

idleCheckInterval = setInterval(() => {
  if (Date.now() - lastActivity > IDLE_THRESHOLD && !idlePaused) {
    // Detect idle: pause everything that is running
    const paused = [];
    if (SS.running) { toggleSitstand(); paused.push('__SS__'); }
    MASTER_KEYS.forEach(k => { if (timers[k].running) { toggleTimer(k); paused.push(k); } });
    if (paused.length > 0) {
      idlePaused = true;
      sessionStorage.setItem('idlePausedTimers', JSON.stringify(paused));
      document.getElementById('idleBanner').classList.add('active');
    }
  }
}, 30000); // check every 30s

// ===== KEYBOARD SHORTCUTS =====
document.addEventListener('keydown', e => {
  // Space = master toggle (when not typing in an input)
  if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
    e.preventDefault();
    masterToggle();
  }
  // Escape = close open modal
  if (e.code === 'Escape') {
    closeSettings();
    closeAnalytics();
  }
});

// ===== ANALYTICS =====
function openAnalytics() {
  renderAnalytics();
  document.getElementById('analyticsModal').classList.add('open');
}

function closeAnalytics() {
  document.getElementById('analyticsModal').classList.remove('open');
}

function closeAnalyticsOnOverlay(e) {
  if (e.target === document.getElementById('analyticsModal')) closeAnalytics();
}

function getLast7Days() {
  const days = [];
  for (let i = 6; i >= 0; i--) {
    const d = new Date();
    d.setDate(d.getDate() - i);
    days.push(d.toISOString().split('T')[0]);
  }
  return days;
}

function renderAnalytics() {
  const s = loadState();
  const history = s.history || {};
  const days = getLast7Days();

  // Include today's live data
  const todayData = { breaks: dailyBreaks, water: waterCount, focus: dailyFocus };

  const breaksData  = days.map(d => d === TODAY ? todayData.breaks : (history[d] ? history[d].breaks : 0));
  const waterData   = days.map(d => d === TODAY ? todayData.water  : (history[d] ? history[d].water  : 0));
  const focusData   = days.map(d => d === TODAY ? todayData.focus  : (history[d] ? history[d].focus  : 0));

  const labels = days.map(d => {
    const dt = new Date(d + 'T00:00:00');
    return dt.toLocaleDateString('en-US', { weekday: 'short' });
  });

  buildChart('chartBreaks', 'chartBreaksDays', breaksData, labels, 'var(--accent-eyes)', days);
  buildChart('chartWater',  'chartWaterDays',  waterData,  labels, 'var(--accent-hydration)', days);
  buildChart('chartFocus',  'chartFocusDays',  focusData,  labels, 'var(--accent-focus)', days);

  // Summary stats (7-day totals)
  const totalBreaks = breaksData.reduce((a, b) => a + b, 0);
  const totalWater  = waterData.reduce((a, b) => a + b, 0);
  const totalFocus  = focusData.reduce((a, b) => a + b, 0);
  const avgBreaks   = (totalBreaks / 7).toFixed(1);
  const avgWater    = (totalWater  / 7).toFixed(1);

  document.getElementById('analyticsSummary').innerHTML = `
    <div class="analytics-stat"><div class="analytics-stat-val">${totalBreaks}</div><div class="analytics-stat-label">Breaks (7d)</div></div>
    <div class="analytics-stat"><div class="analytics-stat-val">${avgBreaks}</div><div class="analytics-stat-label">Avg breaks/day</div></div>
    <div class="analytics-stat"><div class="analytics-stat-val">${totalWater}</div><div class="analytics-stat-label">Glasses (7d)</div></div>
    <div class="analytics-stat"><div class="analytics-stat-val">${avgWater}</div><div class="analytics-stat-label">Avg glasses/day</div></div>
    <div class="analytics-stat"><div class="analytics-stat-val">${totalFocus}</div><div class="analytics-stat-label">Focus sessions (7d)</div></div>
  `;
}

function buildChart(barContainerId, daysContainerId, data, labels, color, days) {
  const maxVal = Math.max(...data, 1);
  const barWrap = document.getElementById(barContainerId);
  const dayWrap = document.getElementById(daysContainerId);

  barWrap.innerHTML = '';
  dayWrap.innerHTML = '';

  data.forEach((val, i) => {
    const isToday = days[i] === TODAY;
    const pct = (val / maxVal) * 100;

    const col = document.createElement('div');
    col.className = 'chart-col' + (isToday ? ' chart-today' : '');

    const valEl = document.createElement('div');
    valEl.className = 'chart-val';
    valEl.textContent = val;

    const barWrapEl = document.createElement('div');
    barWrapEl.className = 'chart-bar-wrap';
    barWrapEl.style.cssText = 'flex:1; display:flex; align-items:flex-end; width:100%;';

    const bar = document.createElement('div');
    bar.className = 'chart-bar';
    bar.style.cssText = `height:${pct}%; background:${color}; width:100%; opacity:${isToday ? '1' : '0.55'};`;

    barWrapEl.appendChild(bar);
    col.appendChild(valEl);
    col.appendChild(barWrapEl);
    barWrap.appendChild(col);

    const dayEl = document.createElement('div');
    dayEl.className = 'chart-label' + (isToday ? ' chart-today' : '');
    dayEl.style.cssText = `flex:1; text-align:center; font-size:0.6rem; color:${isToday ? 'var(--text)' : 'var(--muted)'};`;
    dayEl.textContent = labels[i];
    dayWrap.appendChild(dayEl);
  });
}

// ===== INIT =====
Object.keys(timers).forEach(k => updateRing(timers[k], timers[k].duration, timers[k].duration));
updateSSRing();
updateFocusRing();

// Load settings and apply durations
(function initSettings() {
  const cfg = getSettings();
  timers.eyes.duration = timers.eyes.remaining = cfg.eyesDuration * 60;
  timers.shoulder.duration = timers.shoulder.remaining = cfg.shoulderDuration * 60;
  timers.walk.duration = timers.walk.remaining = cfg.walkDuration * 60;
  timers.hydration.duration = timers.hydration.remaining = cfg.hydrationDuration * 60;
  timers.wrist.duration = timers.wrist.remaining = cfg.wristDuration * 60;
  timers.neck.duration = timers.neck.remaining = cfg.neckDuration * 60;
  timers.breath.duration = timers.breath.remaining = cfg.breathDuration * 60;
  SS.durations.sit = cfg.sitDuration * 60;
  SS.durations.stand = cfg.standDuration * 60;
  SS.remaining = SS.durations.sit;

  document.getElementById('hintSit').textContent = cfg.sitDuration;
  document.getElementById('hintStand').textContent = cfg.standDuration;

  Object.keys(timers).forEach(k => {
    document.getElementById(timers[k].countdownId).textContent = fmt(timers[k].duration);
    updateRing(timers[k], timers[k].duration, timers[k].duration);
  });
  document.getElementById('sitstandCountdown').textContent = fmt(SS.remaining);
  updateSSRing();
})();

// Load daily state
loadDailyStats();
loadStreak();
loadEodState();
renderWaterGlasses();
syncMasterBtn();
</script>
</body>
</html>
